<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Holo Wang"><meta name="description" content="创建自己的第一个CordovaPlugin"><meta name="keywords" content="Cordova"><title>Cordova ： 自定义Plugin · 加贝龙</title><link rel="icon" href="/long_02.jpg"><link rel="canonical" href="http://yoursite.com/2017/04/08/Cordova_custom_plugin/"><link rel="alternate" href="/atom.xml" title="加贝龙"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">加贝龙</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">首页</a></li><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/categories/" target="_self">分类</a></li><li class="nav-link"><a href="/tags/" target="_self">标签</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Cordova ： 自定义Plugin</h1><span class="post-time">2017年4月8日</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Cordova之自定义Plugin"><span class="toc-text">Cordova之自定义Plugin</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-原生插件开发"><span class="toc-text">1.原生插件开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-注册原生插件"><span class="toc-text">2.注册原生插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-js插件开发"><span class="toc-text">3.js插件开发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-注册js插件"><span class="toc-text">3.注册js插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-调用js插件"><span class="toc-text">4.调用js插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-加载js文件"><span class="toc-text">5.加载js文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-运行"><span class="toc-text">6.运行</span></a></li></ol></li></ol></div><div class="post-content"><h3 id="Cordova之自定义Plugin"><a href="#Cordova之自定义Plugin" class="headerlink" title="Cordova之自定义Plugin"></a>Cordova之自定义Plugin</h3><p>本文通过自定义一个简单的Toast插件来介绍一下如何从0开始自定义自己的plugin，基于cordova6.2.1版本。在这之前你需要创建一个Cordova项目，如何创建一个Corodva项目可以参考<a href="http://kidloserme.github.io/2016/11/25/Cordova_Plugin_2016-11-25/" target="_blank" rel="external">Cordova：Plugin</a>中的1-5步骤，这里不在赘述。</p>
<h4 id="1-原生插件开发"><a href="#1-原生插件开发" class="headerlink" title="1.原生插件开发"></a>1.原生插件开发</h4><p>首先创建一个<code>ToastPlugin</code>，我把他放在了主工程中，所有自定义的<code>Plugin</code>都是继承自<code>CordovaPlugin</code>，然后重写<code>CordovaPlugin</code>的<code>execute</code>方法来实现插件的功能，<code>CordovaPlugin</code>中定义了三个<code>execute</code>，这里我选择重写方法<code>public boolean execute(String action, JSONArray args, CallbackContext callbackContext)</code>，至于重写哪个好，全凭自己喜欢。下面看下<code>ToastPlugin</code>的代码：</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class ToastPlugin extends CordovaPlugin &#123;</div><div class="line"></div><div class="line">    private String ACTION_TOAST = &quot;toast&quot;;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * @param action          具体要执行的动作，由H5传入</div><div class="line">     * @param args            参数列表，H5传入</div><div class="line">     * @param callbackContext 回调</div><div class="line">     * @return true:有效的action  false:无效的action</div><div class="line">     * @throws JSONException</div><div class="line">     */</div><div class="line">    @Override</div><div class="line">    public boolean execute(String action, JSONArray args,</div><div class="line">                           CallbackContext callbackContext) throws JSONException &#123;</div><div class="line">        if (ACTION_TOAST.equals(action)) &#123;</div><div class="line">            toast(args.getString(0), callbackContext);</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 处理toast逻辑</div><div class="line">     *</div><div class="line">     * @param content toast弹出的内容</div><div class="line">     * @param callbackContext 回调</div><div class="line">     */</div><div class="line">    private void toast(String content, CallbackContext callbackContext) &#123;</div><div class="line">        Toast.makeText(cordova.getActivity(), content, Toast.LENGTH_LONG).show();</div><div class="line">        PluginResult pluginResult = new PluginResult(PluginResult.Status.OK,</div><div class="line">                &quot;this is toast callback content !&quot;);</div><div class="line">        callbackContext.sendPluginResult(pluginResult);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面就是一个简单的插件，<code>execute</code>是入口，接收H5发送过来的请求，根据具体的action来执行不同的逻辑，并根据结果来通过<code>callbackContext</code>发送回调结果。<br><strong>参数理解：</strong><br><strong>action：</strong> 应该很好理解的，比如我们现在写的是一个对话框插件，可能就会有按钮操作，那么需要定义三个action:alert, cancel, confirm。根据不同的action执行不同的逻辑。<br><strong>args：</strong> 参数，是一个数组的形式，H5在调用的时候会把参数封装成一个json数组格式的字符串。<br><strong>callbackContext：</strong> 原生插件通过这个参数来给H5发送反馈，当然这个不是必须的，根据需要来写。发送的数据类型为<code>PluginResult</code>,状态<code>PluginResult.Status.OK</code>表示成功，状态’PluginResult.Status.ERROR’表示失败，当然还是有其他类型的状态，可以查看<code>luginResult.Status</code>的具体定义。</p>
<h4 id="2-注册原生插件"><a href="#2-注册原生插件" class="headerlink" title="2.注册原生插件"></a>2.注册原生插件</h4><p>第1步中创建了一个原生插件，下一步就是注册插件，只有注册了插件，在Cordova初始化的时候才能根据注册信息来获取该插件并实例化，后面调用的时候才能找得到它。配置的地方就是res目录下的xml目录下的config.xml文件。在其中加一个节点：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version='1.0' encoding='utf-8'?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">widget</span> <span class="attr">id</span>=<span class="string">"com.helong.cordova"</span> <span class="attr">version</span>=<span class="string">"1.0.0"</span> </span></div><div class="line">        <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/ns/widgets"</span> </div><div class="line">        <span class="attr">xmlns:cdv</span>=<span class="string">"http://cordova.apache.org/ns/1.0"</span>&gt;</div><div class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">name</span>=<span class="string">"Whitelist"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"android-package"</span> <span class="attr">value</span>=<span class="string">"org.apache.cordova.whitelist.WhitelistPlugin"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"onload"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">feature</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">name</span>=<span class="string">"Toast"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"android-package"</span> <span class="attr">value</span>=<span class="string">"com.helong.plugin.ToastPlugin"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">feature</span>&gt;</span></div><div class="line">    .....此处为节省空间省略</div><div class="line"><span class="tag">&lt;/<span class="name">widget</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>一个<code>feature</code>代表一个原生插件，属性<code>name</code>是这个原生插件的名字，<code>param</code>的<code>android-package</code>用来指定这个插件的具体实现类。<br>OK，配置完毕，这样原生部分的工作已经完成了。下面看js方面的工作。</p>
<h4 id="3-js插件开发"><a href="#3-js插件开发" class="headerlink" title="3.js插件开发"></a>3.js插件开发</h4><p>首先在assets目录下的plugins目录下创建一个目录，作为新js插件的目录，目录名cordova-plugin-toast，然后在此目录下创建新的目录，目录名www，最后在www目录下创建我们的js插件toast.js，看图：<br><img src="../../../../images/cordova/createjs.png" alt="Alt text"><br>接下来是具体的实现：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">cordova.define(<span class="string">"cordova-plugin-toast.toast"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> exec = <span class="built_in">require</span>(<span class="string">'cordova/exec'</span>);</div><div class="line">    <span class="keyword">var</span> platform = <span class="built_in">require</span>(<span class="string">'cordova/platform'</span>);</div><div class="line">    <span class="built_in">module</span>.exports = &#123;</div><div class="line">        <span class="attr">toast</span>: <span class="function"><span class="keyword">function</span>(<span class="params">message, completeCallback</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> _message = (<span class="keyword">typeof</span> message === <span class="string">"string"</span> ? message : <span class="built_in">JSON</span>.stringify(message));</div><div class="line">            <span class="comment">//success, fail, service, action, args</span></div><div class="line">            exec(completeCallback, <span class="literal">null</span>, <span class="string">"Toast"</span>, <span class="string">"toast"</span>, [_message]);</div><div class="line">        &#125;,</div><div class="line">    &#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>代码中define的第一个参数”cordova-plugin-toast.toast”是这个plugin的id，在后面会用到。<br>插件的实现部分在module.exports部分，这里面定义了一个函数名字叫<code>toast</code>，有两个参数分别是要展示的内容以及回调，通过exec执行，将内容以及回调传递给原生插件，也就是步骤1中我们写的原生插件。<br><strong>exec说明：</strong><br>exec就是函数<code>function androidExec(success, fail, service, action, args)</code>，具体实现可以看exec.js，在assets/www/corodva-js-src目下，接收的五个参数具体说一下。</p>
<ul>
<li>success是成功回调，对应步骤1中PluginResult的Status.OK</li>
<li>fail是失败回调，对应PluginResult的Status.ERROR</li>
<li>service就是我们原生插件名称，也就是步骤2中注册原生插件中<code>feature</code>节点的<code>name</code>属性定义的名字。</li>
<li>action就是我们原生插件实现是定义的一系列action，步骤一中也有说明，原生插件接到请求根据service找到插件，然后再根据action执行具体的逻辑。</li>
<li>args就是参数，json数组格式，步骤一中也有说明<br>好了，js插件开发完毕，下一步跟原生一样，注册插件。</li>
</ul>
<h4 id="3-注册js插件"><a href="#3-注册js插件" class="headerlink" title="3.注册js插件"></a>3.注册js插件</h4><p>找到此文件assets/www/cordova_plugins.js，我们的js插件需要在这里进行注册了才能被访问，因为cordova.js在加载的时候会从这里面读取信息。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cordova.define(<span class="string">'cordova/plugin_list'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">require, exports, module</span>) </span>&#123;</div><div class="line"><span class="built_in">module</span>.exports = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">"id"</span>: <span class="string">"cordova-plugin-toast.toast"</span>,</div><div class="line">        <span class="string">"file"</span>: <span class="string">"plugins/plugin-toast/www/toast.js"</span>,</div><div class="line">        <span class="string">"pluginId"</span>: <span class="string">"cordova-plugin-toast"</span>,</div><div class="line">        <span class="string">"clobbers"</span>: [</div><div class="line">            <span class="string">"toast123"</span></div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">];</div><div class="line"><span class="built_in">module</span>.exports.metadata = </div><div class="line"><span class="comment">// TOP OF METADATA</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"cordova-plugin-whitelist"</span>: <span class="string">"1.3.2"</span>,</div><div class="line">    <span class="string">"cordova-plugin-toast"</span>: <span class="string">"0.0.1"</span></div><div class="line">&#125;;</div><div class="line"><span class="comment">// BOTTOM OF METADATA</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这里的module.exports是一个Json数组，每一项代表一个插件，说一下插件配置每一项的意思：<br><strong>id：</strong> 就是定义js插件define的第一个参数，在步骤3中已经说明。<br><strong>file：</strong> 很好理解，就是我们js插件所在的路径<br><strong>pluginId：</strong> 插件的pluginId，下面在设置版本信息的时候会用到，其他地方有没有用到，暂时没遇到<br><strong>clobbers：</strong> 这个类似于实例，我们在后面用到js插件的时候就是通过这名称来调用插件里面的函数的，是个数组，可以定义成多个名字。还有另外一种方式，就是使用<code>merges</code>定义，代表允许不同的js插件可以取一个相同的实例名称，例如cordova官方的一个demo如下。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"id"</span>: <span class="string">"cordova-plugin-dialogs.notification"</span>,</div><div class="line">    <span class="string">"file"</span>: <span class="string">"plugins/cordova-plugin-dialogs/www/notification.js"</span>,</div><div class="line">    <span class="string">"pluginId"</span>: <span class="string">"cordova-plugin-dialogs"</span>,</div><div class="line">    <span class="string">"merges"</span>: [</div><div class="line">        <span class="string">"navigator.notification"</span></div><div class="line">    ]</div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">    <span class="string">"id"</span>: <span class="string">"cordova-plugin-dialogs.notification_android"</span>,</div><div class="line">    <span class="string">"file"</span>: <span class="string">"plugins/cordova-plugin-dialogs/www/android/notification.js"</span>,</div><div class="line">    <span class="string">"pluginId"</span>: <span class="string">"cordova-plugin-dialogs"</span>,</div><div class="line">    <span class="string">"merges"</span>: [</div><div class="line">        <span class="string">"navigator.notification"</span></div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>OK ，js插件已经注册完毕，下面就是使用了吧。</p>
<h4 id="4-调用js插件"><a href="#4-调用js插件" class="headerlink" title="4.调用js插件"></a>4.调用js插件</h4><p>这里用一个比较简单的例子，就是在设备准备好的时候执行这个js。我们在assets/www/js目录下新建一个ready.js文件，然后编码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">    alert(message);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">onDeviceReady</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    toast123.toast(<span class="string">'Hello My Plaugin !'</span>,success);</div><div class="line">&#125;</div><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">"deviceready"</span>, onDeviceReady, <span class="literal">false</span>);</div></pre></td></tr></table></figure></p>
<p>嗯，就是监听deviceready事件，然后进行响应，捕获到此事件后进行toast，并接收回调。</p>
<h4 id="5-加载js文件"><a href="#5-加载js文件" class="headerlink" title="5.加载js文件"></a>5.加载js文件</h4><p>插件的开发以及调用都已经开发完毕，最后一步就是执行了吧。这里使用assets/www/index.html，app启动时默认加载这个html，我们就再这里调用4中的ready.js文件。在原先的html中加入js引用<code>&lt;script type=&quot;text/javascript&quot; src=&quot;js/ready.js&quot;&gt;&lt;/script&gt;</code>。<br>万事俱备，只差运行了吧。</p>
<h4 id="6-运行"><a href="#6-运行" class="headerlink" title="6.运行"></a>6.运行</h4><p>看效果图，下面是toast的内容，上面的对话框里的内容就是我们原生插件设置callback时 的内容。<br><img src="../../../../images/cordova/run.png" alt="Alt text"></p>
<p>一个简单的插件完成了，算是入门了，剩下的就要靠自己了。</p>
</div></article><div class="tags"><a href="/tags/Cordova/">Cordova</a></div><div class="paginator"><a href="/2016/11/25/JingoalPush_2016-11-25/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2017<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Holo Wang</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>
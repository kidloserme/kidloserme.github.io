<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Holo Wang"><meta name="description" content="1.Observables先认识几个重要的概念Observable：一个可观察对象或者被观察者Observer：观察者（订阅者）Subscribe：Observer的子类，比Observer多了onStart和unsubscribe两个方法在RxJava中，"><meta name="keywords" content="Rxjava_Create"><title>操作符Create · 加贝龙</title><link rel="icon" href="/long_02.jpg"><link rel="canonical" href="http://yoursite.com/2016/09/24/RxJava_Create_2016-09-24/"><link rel="alternate" href="/atom.xml" title="加贝龙"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">加贝龙</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">首页</a></li><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/categories/" target="_self">分类</a></li><li class="nav-link"><a href="/tags/" target="_self">标签</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">操作符Create</h1><span class="post-time">2016年9月24日</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Observables"><span class="toc-text">1.Observables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-操作符Create"><span class="toc-text">2.操作符Create</span></a></li></ol></div><div class="post-content"><h3 id="1-Observables"><a href="#1-Observables" class="headerlink" title="1.Observables"></a>1.Observables</h3><p> 先认识几个重要的概念    </p>
<ul>
<li><strong>Observable</strong>：一个可观察对象或者被观察者</li>
<li><strong>Observer</strong>：观察者（订阅者）</li>
<li><strong>Subscribe</strong>：Observer的子类，比Observer多了onStart和unsubscribe两个方法</li>
</ul>
<p>在RxJava中，一个实现了Observer接口的对象可以订阅(subscribe)一个Observable 类的实例。订阅者(subscriber)对Observable发射(emit)的任何数据或数据序列作出响应。</p>
<a id="more"></a>
<h3 id="2-操作符Create"><a href="#2-操作符Create" class="headerlink" title="2.操作符Create"></a>2.操作符Create</h3><blockquote>
<p><strong>2.1 概要步骤：</strong></p>
</blockquote>
<ol>
<li>创建被观察者  <font style="color:red">Observable observable = new Observable();</font></li>
<li>创建观察者  <font color="green">Observer observer = new Observer();</font></li>
<li>观察者订阅被观察者  <font style="color:red">observable</font>.subscribe(<font color="green">observer</font>);</li>
</ol>
<blockquote>
<p><strong>2.2 实际使用：</strong></p>
</blockquote>
<pre style="background:#23241f;padding:7px 0px 0px 20px"><code style="background:#23241f;color:red;">
<span style="color:white">1.创建被观察者</span>
Observable&lt;<span>String</span>&gt; observable = Observable.create(<span>new</span> Observable.OnSubscribe&lt;<span>String</span>&gt;(){<br>    <span>@Override</span> public <span>void</span> call(Subscriber&lt;? <span>super</span> <span>String</span>&gt; subscriber) {<br>        <span style="color:gray">// TODO(HeLong.W): todo somthing</span><br>    }<br>});<br>
</code></pre>

<pre style="background:#23241f;padding:7px 0px 0px 20px"><code style="background:#23241f;color:green;">
<span style="color:white">2.创建观察者</span>
Observer&lt;String&gt; observer = new Observer&lt;String&gt;() {
    @Override public void onCompleted() {
    }
    @Override public void onError(Throwable e) {
    }
    @Override public void onNext(String o) {
    }
};
<br></code></pre>

<pre style="color:white;background:#23241f;padding:7px 0px 0px 20px"><code style="background:#23241f;">
<span>3.观察者订阅被观察者</span><br><font style="color:red;">observable</font>.subscribe(<font style="color:green;">observer</font>);
</code>
</pre>

<pre style="color:white;background:#23241f;padding:7px 0px 0px 20px"><code style="background:#23241f;">
综合1、2、3来写：
<span style="color:red">Observable.create(new Observable.OnSubscribe&lt;String&gt;() {
    @Override public void call(Subscriber&lt;? super String&gt; subscriber) {
        subscriber.onNext("Hello");
        subscriber.onCompleted();
    }
})</span>.subscribe(<span style="color:green">new Subscriber&lt;String&gt;() {
    @Override public void onCompleted() {
        System.out.println("onCompleted exe");
    }
    @Override public void onError(Throwable e) {
    }
    @Override public void onNext(String s) {
        System.out.println(s);
    }
}</span>);<br>
</code></pre>

<blockquote>
<p><strong>2.3 源码分析</strong></p>
</blockquote>
<p>先看一下<code>Observable.create()</code>了什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Observable.class*/</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Observable&lt;T&gt;(hook.onCreate(f));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>create方法很简单，就是调用了默认的构造器，并且传入一个构造器需要的参数，参数值由<code>hook.onCreate(f)</code>返回，先看看这个<code>hook.onCreate(f)</code>是什么鬼：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Observable.class 中定义的hookd变量*/</span></div><div class="line">RxJavaObservableExecutionHook hook = RxJavaPlugins.getInstance().getObservableExecutionHook();</div><div class="line"></div><div class="line"><span class="comment">/*RxJavaObservableExecutionHook.class*/</span></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">OnSubscribe&lt;T&gt; <span class="title">onCreate</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> f;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码可以看到<code>hook.onCreate(f)</code>什么也没做，就是直接返回f，接下来看看默认的构造器干什么了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">Observable</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.onSubscribe = f;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也是很简单的给自己的成员变量<code>onSubscribe</code>赋值而已。那么接下来看看这个<code>OnSubscribe</code>是什么呢？从上面的代码看OnSubscribe是<code>Observable</code>的一个内部类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnSubscribe</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Action1</span>&lt;<span class="title">Subscriber</span>&lt;? <span class="title">super</span> <span class="title">T</span>&gt;&gt; </span>&#123;</div><div class="line">    <span class="comment">// cover for generics insanity</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>额，原来是一个接口，看他的超类定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A one-argument action.</div><div class="line"> * <span class="doctag">@param</span> &lt;T&gt; the first argument type</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Action1</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Action</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">call</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也很简洁，就是一个带有一个泛型参数的接口，那么上面的子类<code>OnSubscribe</code>就是指定了这个泛型的类型为<code>Subscriber</code>类型的，而指定的这个<code>Subscriber</code>就是后面要说的观察者。</p>
<p>看完了被观察者，再来看看观察者，一个接口类，提供了三个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们上面设置观察者的时候使用的是<code>Subscriber</code>，那么<code>Subscriber</code>跟<code>Observer</code>的关系是什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Subscriber</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt;, <span class="title">Subscription</span></span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">()</span> </span>&#123;</div><div class="line">        subscriptions.unsubscribe();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isUnsubscribed</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> subscriptions.isUnsubscribed();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// do nothing by default</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看上去有点复杂，多了几个方法，<code>onStart , unsubscribe , isUnsubscribed</code>.不多做说明，后面会说到，只需要知道<code>Subscriber</code>和<code>Observer</code>是继承关系即可，都可以作为观察者。<br>接下来看最关键的一部分了，观察者与被观察者关联的过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Observable.class*/</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Subscription <span class="title">subscribe</span><span class="params">(<span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (observer <span class="keyword">instanceof</span> Subscriber) &#123;</div><div class="line">         <span class="keyword">return</span> subscribe((Subscriber&lt;? <span class="keyword">super</span> T&gt;)observer);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> subscribe(<span class="keyword">new</span> ObserverSubscriber&lt;T&gt;(observer));</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>虽然有个if判断，但是两个分支最后走的是同一个方法，所以直接看这个<code>Subscription subscribe(Subscriber&lt;? super T&gt; subscriber)</code>实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Observable.class*/</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Subscription <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.subscribe(subscriber, <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>额，还没走到真正处理的地方，继续跟，一大波代码来临，终于看见了曙光：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &lt;T&gt; <span class="function">Subscription <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber, Observable&lt;T&gt; observable)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (subscriber == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"subscriber can not be null"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (observable.onSubscribe == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"onSubscribe function can not be null."</span>);</div><div class="line">    &#125;</div><div class="line">    subscriber.onStart();</div><div class="line">    <span class="keyword">if</span> (!(subscriber <span class="keyword">instanceof</span> SafeSubscriber)) &#123;</div><div class="line">        subscriber = <span class="keyword">new</span> SafeSubscriber&lt;T&gt;(subscriber);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        hook.onSubscribeStart(observable, observable.onSubscribe).call(subscriber);</div><div class="line">        <span class="keyword">return</span> hook.onSubscribeReturn(subscriber);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">       <span class="comment">//异常处理....</span></div><div class="line">        <span class="keyword">return</span> Subscriptions.unsubscribed();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>又碰到了<code>hook</code>,看看<code>hook.onSubscribeStart(observable, observable.onSubscribe)</code>这个干嘛的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">OnSubscribe&lt;T&gt; <span class="title">onSubscribeStart</span><span class="params">(Observable&lt;? extends T&gt; observableInstance, <span class="keyword">final</span> OnSubscribe&lt;T&gt; onSubscribe)</span> </span>&#123;</div><div class="line">    <span class="comment">// pass through by default</span></div><div class="line">    <span class="keyword">return</span> onSubscribe;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>依然什么也没做，直接返回了第二个参数<code>onSubscribe</code>,那<code>hook.onSubscribeStart(observable, observable.onSubscribe).call(subscriber);</code>可以替换成<code>observable.onSubscribe.call(subscriber);</code>，接下来关键就看这个<code>call()</code>做了什么？先看看调用这个<code>call</code>的是谁？是<code>observable.onSubscribe</code>，那这个<code>observable.onSubscribe</code>又是谁？他就是我们第一步<code>create</code>时设置的<code>onSubscribe</code>！所以这里的<code>call</code>做了什么，取决于我们！一般我们就在<code>call</code>里面先处理数据，然后调用<code>onNext</code>方法即可。<br>最后看一下还有一个<code>return hook.onSubscribeReturn(subscriber)</code>,看一下内部实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Subscription <span class="title">onSubscribeReturn</span><span class="params">(Subscription subscription)</span> </span>&#123;</div><div class="line">    <span class="comment">// pass through by default</span></div><div class="line">    <span class="keyword">return</span> subscription;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>依然什么也没做，把参数直接返回了。那么返回的这个Subscription是干嘛用的，我们来看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subscription</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unsubscribe</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isUnsubscribed</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>原来是用来取消订阅观察的，如果调用了<code>unsubscribe()</code>后，这个观察者就不再起作用了。</p>
</div></article><div class="tags"><a href="/tags/Rxjava-Create/">Rxjava_Create</a></div><div class="paginator"><a href="/2016/09/24/2016-03-09-mediacodec/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Holo Wang</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>
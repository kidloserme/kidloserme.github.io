<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Holo Wang"><meta name="description" content="之前看过EventBus的源码，不是很深入，导致有些模糊，此次仔细阅读了一下，记录笔记，方便以后熟悉。本篇主要说一下register的过程：12345678privatesynchronizedvoidregister(Objectsubscriber,boolean"><meta name="keywords" content="EventBus简要分析"><title>EventBus源码阅读之事件的注册 · 加贝龙</title><link rel="icon" href="/long_02.jpg"><link rel="canonical" href="http://yoursite.com/2016/09/24/2016-03-17-EventBus/"><link rel="alternate" href="/atom.xml" title="加贝龙"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">加贝龙</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">首页</a></li><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/categories/" target="_self">分类</a></li><li class="nav-link"><a href="/tags/" target="_self">标签</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">EventBus源码阅读之事件的注册</h1><span class="post-time">2016年9月24日</span><div class="post-content"><p>之前看过EventBus的源码，不是很深入，导致有些模糊，此次仔细阅读了一下，记录笔记，方便以后熟悉。<br>本篇主要说一下register的过程：<br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> priority)</span> </span>&#123;</div><div class="line">	<span class="comment">//查找subscriber（执行register的类）中注册事件的方法，onEvent开头，参数只允许一个，超过一个将被忽略</span></div><div class="line">   List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriber.getClass());</div><div class="line">   <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</div><div class="line">       <span class="comment">//根据事件类型以及订阅类进行数据处理</span></div><div class="line">       subscribe(subscriber, subscriberMethod, sticky, priority);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>findSubscriberMethods这个方法很长，大致要做的事情就是查找出该类以及其父类中声明的所有方法，根据规则（只能public修饰onEvent开头且只有一个参数）筛选出订阅方法，一起看一下吧，具体就在代码中写说明了，删除了部分代码限制篇幅：<br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">	<span class="comment">//省略部分代码</span></div><div class="line">   subscriberMethods = <span class="keyword">new</span> ArrayList&lt;SubscriberMethod&gt;();</div><div class="line">   Class&lt;?&gt; clazz = subscriberClass;</div><div class="line">   HashSet&lt;String&gt; eventTypesFound = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">   StringBuilder methodKeyBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">   <span class="keyword">while</span> (clazz != <span class="keyword">null</span>) &#123;</div><div class="line">       String name = clazz.getName();</div><div class="line">       <span class="comment">//忽略系统类</span></div><div class="line">       <span class="keyword">if</span> (name.startsWith(<span class="string">"java."</span>) || name.startsWith(<span class="string">"javax."</span>) || name.startsWith(<span class="string">"android."</span>)) &#123;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//获取该类中声明的所有方法</span></div><div class="line">       Method[] methods = clazz.getDeclaredMethods();</div><div class="line">       <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">           String methodName = method.getName();</div><div class="line">           <span class="comment">//是否以onEvent开头</span></div><div class="line">           <span class="keyword">if</span> (methodName.startsWith(ON_EVENT_METHOD_NAME)) &#123;</div><div class="line">               <span class="keyword">int</span> modifiers = method.getModifiers();</div><div class="line">               <span class="comment">//修饰符只能以public开头</span></div><div class="line">               <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">                   Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">                   <span class="comment">//只能有一个参数</span></div><div class="line">                   <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">                       String modifierString = methodName.substring(ON_EVENT_METHOD_NAME.length());</div><div class="line">                       ThreadMode threadMode;</div><div class="line">                       <span class="comment">//获取线程执行方式</span></div><div class="line">                       <span class="keyword">if</span> (modifierString.length() == <span class="number">0</span>) &#123;</div><div class="line">                           threadMode = ThreadMode.PostThread;</div><div class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modifierString.equals(<span class="string">"MainThread"</span>)) &#123;</div><div class="line">                           threadMode = ThreadMode.MainThread;</div><div class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modifierString.equals(<span class="string">"BackgroundThread"</span>)) &#123;</div><div class="line">                           threadMode = ThreadMode.BackgroundThread;</div><div class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modifierString.equals(<span class="string">"Async"</span>)) &#123;</div><div class="line">                           threadMode = ThreadMode.Async;</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       	<span class="comment">//省略部分代码</span></div><div class="line">                       &#125;</div><div class="line">                       Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</div><div class="line">                       methodKeyBuilder.setLength(<span class="number">0</span>);</div><div class="line">                       methodKeyBuilder.append(methodName).append(<span class="string">'&gt;'</span>).append(eventType.getName());</div><div class="line">                       String methodKey = methodKeyBuilder.toString();</div><div class="line">                       <span class="comment">//检查是否已经添加过</span></div><div class="line">                       <span class="keyword">if</span> (eventTypesFound.add(methodKey)) &#123;</div><div class="line">                           <span class="comment">// Only add if not already found in a sub class</span></div><div class="line">                       	<span class="comment">//添加到列表中</span></div><div class="line">                           subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, threadMode, eventType));</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!skipMethodVerificationForClasses.containsKey(clazz)) &#123;</div><div class="line">                   Log.d(EventBus.TAG, <span class="string">"Skipping method (not public, static or abstract): "</span> + clazz + <span class="string">"."</span></div><div class="line">                           + methodName);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//获取父类并且继续查找父类中的订阅方法</span></div><div class="line">       clazz = clazz.getSuperclass();</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//省略部分代码</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来看subscribe(subscriber, subscriberMethod, sticky, priority);这个方法是干啥的，总结来说就是把所有事件类型为eventType的订阅者放入List列表中，并放入Map集合中。然后再根据订阅事件的类构造一个订阅事件列表，用来判断某个类是否已经注册过事件,看一下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> priority)</span> </span>&#123;</div><div class="line">    <span class="comment">//获取订阅事件中的时间类型</span></div><div class="line">    Class&lt;?&gt; eventType = subscriberMethod.eventType;</div><div class="line">    <span class="comment">//根据事件类型查找对应的所有订阅者（由类、方法、优先级组成）</span></div><div class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</div><div class="line">    <span class="comment">//创建一个新的订阅者</span></div><div class="line">    Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod, priority);</div><div class="line">    <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</div><div class="line">        subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Subscription&gt;();</div><div class="line">        <span class="comment">//将订阅者列表放入Map中，后面post的时候会会根据这个eventType来获取该订阅者列表，然后来触发事件</span></div><div class="line">        subscriptionsByEventType.put(eventType, subscriptions);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    	<span class="comment">//不允许重复注册</span></div><div class="line">        <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span></div><div class="line">                    + eventType);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Starting with EventBus 2.2 we enforced methods to be public (might change with annotations again)</span></div><div class="line">    <span class="comment">// subscriberMethod.method.setAccessible(true);</span></div><div class="line">    <span class="comment">//根据优先级将新的订阅者插入到已有的订阅者列表中</span></div><div class="line">    <span class="keyword">int</span> size = subscriptions.size();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (i == size || newSubscription.priority &gt; subscriptions.get(i).priority) &#123;</div><div class="line">            subscriptions.add(i, newSubscription);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//根据订阅类查找该订阅类中订阅事件类型，isRegister方法会用到此Map，判断是否已经注册过事件</span></div><div class="line">    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</div><div class="line">    <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</div><div class="line">        subscribedEvents = <span class="keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();</div><div class="line">        typesBySubscriber.put(subscriber, subscribedEvents);</div><div class="line">    &#125;</div><div class="line">    subscribedEvents.add(eventType);</div><div class="line"></div><div class="line">    <span class="comment">//粘性事件</span></div><div class="line">    <span class="keyword">if</span> (sticky) &#123;</div><div class="line">    	<span class="comment">//指定粘性事件是否只触发订阅了当前事件类型的子类的订阅者</span></div><div class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</div><div class="line">        	<span class="comment">//stickyEvents中key为事件类名，value为事件类的实例</span></div><div class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</div><div class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</div><div class="line">                <span class="comment">//eventType类是否是candidateEventType类的父类</span></div><div class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</div><div class="line">                    Object stickyEvent = entry.getValue();</div><div class="line">                    <span class="comment">//触发事件</span></div><div class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">        	<span class="comment">//获取所有黏性事件并触发</span></div><div class="line">            Object stickyEvent = stickyEvents.get(eventType);</div><div class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>post有两种，一种是在UI线程中，一种是子线程中执行，需要注意的是如果你post的事件类型为A，那么所有订阅过A的超类的事件也同样会被触发，时间原因，源码不分析，后续有时间接着写，记此笔记，方便自己查阅！</p>
</div></article><div class="tags"><a href="/tags/EventBus/">EventBus</a></div><div class="paginator"><a href="/2016/09/24/2016-03-17-Points/" class="prev"><i class="iconfont icon-left"></i><span> 上一页</span></a><a href="/2016/09/24/hello-world/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Holo Wang</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>
<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Holo Wang"><meta name="description" content="最近在研究EasyDarwin的Push库EasyPuhser，EasyPuhser可以推送H264视频到Easydarwin服务器，终端可以通过rtsp协议访问该实时流，达到手机直播的功能，延迟基本在2秒以内。EasyDarwinQQ群：496258327本文主要记录一下最近研"><meta name="keywords" content="MediaCodec Android硬编码"><title>Android MediaCodec 硬编码H264格式 · 加贝龙</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2016/09/24/2016-03-09-mediacodec/"><link rel="alternate" href="/atom.xml" title="加贝龙"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">加贝龙</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">首页</a></li><li class="nav-link"><a href="/archives/" target="_self">归档</a></li><li class="nav-link"><a href="/categories/" target="_self">分类</a></li><li class="nav-link"><a href="/tags/" target="_self">标签</a></li><li class="nav-link"><a href="/about/" target="_self">关于</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">Android MediaCodec 硬编码H264格式</h1><span class="post-time">2016年9月24日</span><div class="post-content"><p>最近在研究EasyDarwin的Push库EasyPuhser，EasyPuhser可以推送H264视频到Easydarwin服务器，终端可以通过rtsp协议访问该实时流，达到手机直播的功能，延迟基本在2秒以内。<br>EasyDarwinQQ群：496258327<br>本文主要记录一下最近研究的关于Android手机如何获取实时画面，并将数据编码为H264的格式的视频流，编码使用的是Android自带的MediaCodec，也就是硬解。<br>本demo的下载地址：<a href="https://github.com/kidloserme/MediaCodecDemo" target="_blank" rel="external">MediaCodecDemo</a></p>
<a id="more"></a>
<p>MediaCodec是Android在4.1中加入的新的API，目前也有很多文章介绍MediaCodec的用法，但是很多时候很多手机都失败，主要问题出现在调用dequeueOutputBuffer的时候总是返回-1，让你以为No buffer available !这里介绍一个开源项目<a href="https://github.com/fyhertz/libstreaming" target="_blank" rel="external">libstreaming</a>,我们借助此项目中封装的一个工具类<a href="https://github.com/fyhertz/libstreaming/tree/master/src/net/majorkernelpanic/streaming/hw" target="_blank" rel="external">EncoderDebugger</a>，来初始化MediaCodec会很好的解决此问题，目前为止测试了几个手机都可以成功，包括小米华为Moto。<br>看一下怎么使用的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">EncoderDebugger debugger = EncoderDebugger.debug(getApplicationContext(), width, height);</div><div class="line">MediaCodec mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());</div></pre></td></tr></table></figure>
<p>嗯，就这样。当然了，后面还是要根据需要对mMediaCodec设置其他参数的，看一下本demo中设置参数的过程吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMediaCodec</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> dgree = getDgree();</div><div class="line">    framerate = <span class="number">15</span>;</div><div class="line">    bitrate = <span class="number">2</span> * width * height * framerate / <span class="number">20</span>;</div><div class="line">    EncoderDebugger debugger = EncoderDebugger.debug(getApplicationContext(), width, height);</div><div class="line">    mConvertor = debugger.getNV21Convertor();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        mMediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());</div><div class="line">        MediaFormat mediaFormat;</div><div class="line">        <span class="keyword">if</span> (dgree == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">//dree==0的时候，需要将画面旋转90度，所以这里编码的时候需要将宽和高颠倒，</span></div><div class="line">            <span class="comment">//否则编码后的会面会出现四重画面并且花屏</span></div><div class="line">            mediaFormat = MediaFormat.createVideoFormat(<span class="string">"video/avc"</span>, height, width);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mediaFormat = MediaFormat.createVideoFormat(<span class="string">"video/avc"</span>, width, height);</div><div class="line">        &#125;</div><div class="line">        mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitrate);</div><div class="line">        mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, framerate);</div><div class="line">        mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,</div><div class="line">                debugger.getEncoderColorFormat());</div><div class="line">        mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, <span class="number">1</span>);</div><div class="line">        mMediaCodec.configure(mediaFormat, <span class="keyword">null</span>, <span class="keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</div><div class="line">        mMediaCodec.start();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编码之前先看一下要编码的数据怎么获取吧，这个当然是来自Camera。<br>首先是创建SurfaceView用于预览视频画面，并设置回调，来监控生命周期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">surfaceView = (SurfaceView) findViewById(R.id.sv_surfaceview);</div><div class="line">surfaceView.getHolder().addCallback(<span class="keyword">this</span>);</div><div class="line">surfaceView.getHolder().setFixedSize(getResources().getDisplayMetrics().widthPixels,</div><div class="line">getResources().getDisplayMetrics().heightPixels);</div></pre></td></tr></table></figure>
<p>然后是创建Camera的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">ctreateCamera</span><span class="params">(SurfaceHolder surfaceHolder)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//mCameraId=Camera.CameraInfo.CAMERA_FACING_BACK</span></div><div class="line">        mCamera = Camera.open(mCameraId);</div><div class="line">        Camera.Parameters parameters = mCamera.getParameters();</div><div class="line">        Camera.CameraInfo camInfo = <span class="keyword">new</span> Camera.CameraInfo();</div><div class="line">        Camera.getCameraInfo(mCameraId, camInfo);</div><div class="line">        <span class="keyword">int</span> cameraRotationOffset = camInfo.orientation;</div><div class="line">        <span class="comment">//设置预览格式NV21，他属于YUV420SP</span></div><div class="line">        parameters.setPreviewFormat(ImageFormat.NV21);</div><div class="line">        parameters.setPreviewSize(width, height);</div><div class="line">        mCamera.setParameters(parameters);</div><div class="line">        mCamera.autoFocus(<span class="keyword">null</span>);</div><div class="line">        <span class="comment">//计算preview画面需要旋转的角度。目前木有做横竖屏切换的时候无缝旋转画面，后面再搞。</span></div><div class="line">        <span class="keyword">int</span>  displayRotation = (cameraRotationOffset - getDgree() + <span class="number">360</span>) % <span class="number">360</span>;</div><div class="line">        mCamera.setDisplayOrientation(displayRotation);</div><div class="line">        mCamera.setPreviewDisplay(surfaceHolder);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        destroyCamera();</div><div class="line">        e.printStackTrace();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getDgree</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> rotation = getWindowManager().getDefaultDisplay().getRotation();</div><div class="line">    <span class="keyword">int</span> degrees = <span class="number">0</span>;</div><div class="line">    <span class="keyword">switch</span> (rotation) &#123;</div><div class="line">        <span class="keyword">case</span> Surface.ROTATION_0:</div><div class="line">            degrees = <span class="number">0</span>;</div><div class="line">            <span class="keyword">break</span>; <span class="comment">// Natural orientation</span></div><div class="line">        <span class="keyword">case</span> Surface.ROTATION_90:</div><div class="line">            degrees = <span class="number">90</span>;</div><div class="line">            <span class="keyword">break</span>; <span class="comment">// Landscape left</span></div><div class="line">        <span class="keyword">case</span> Surface.ROTATION_180:</div><div class="line">            degrees = <span class="number">180</span>;</div><div class="line">            <span class="keyword">break</span>;<span class="comment">// Upside down</span></div><div class="line">        <span class="keyword">case</span> Surface.ROTATION_270:</div><div class="line">            degrees = <span class="number">270</span>;</div><div class="line">            <span class="keyword">break</span>;<span class="comment">// Landscape right</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> degrees;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>摄像头创建完毕，就是开启预览</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 开启预览</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startPreview</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mCamera != <span class="keyword">null</span> &amp;&amp; !started) &#123;</div><div class="line">        mCamera.startPreview();</div><div class="line">        <span class="keyword">int</span> previewFormat = mCamera.getParameters().getPreviewFormat();</div><div class="line">        Camera.Size previewSize = mCamera.getParameters().getPreviewSize();</div><div class="line">        <span class="keyword">int</span> size = previewSize.width * previewSize.height</div><div class="line">                * ImageFormat.getBitsPerPixel(previewFormat)</div><div class="line">                / <span class="number">8</span>;</div><div class="line">        mCamera.addCallbackBuffer(<span class="keyword">new</span> <span class="keyword">byte</span>[size]);</div><div class="line">        mCamera.setPreviewCallbackWithBuffer(previewCallback);</div><div class="line">        started = <span class="keyword">true</span>;</div><div class="line">        btnSwitch.setText(<span class="string">"停止"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面就是设置了预览回调的方式，回调中将预览画面一帧一帧的返回给我们，给我们的数据就是NV21格式的,根据需要决定是否需要对数据进行旋转，旋转之后，就是转换，将NV21数据转为YUV420P格式的数据，然后就可以编码为H264数据了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">Camera.PreviewCallback previewCallback = <span class="keyword">new</span> Camera.PreviewCallback() &#123;</div><div class="line">    <span class="comment">//mSpsPps用来存储sps pps数据，后面遇到关键帧（I帧），必须将spspps数据加到I帧前面</span></div><div class="line">    <span class="keyword">byte</span>[] mSpsPps = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPreviewFrame</span><span class="params">(<span class="keyword">byte</span>[] data, Camera camera)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        ByteBuffer[] inputBuffers = mMediaCodec.getInputBuffers();</div><div class="line">        ByteBuffer[] outputBuffers = mMediaCodec.getOutputBuffers();</div><div class="line">        <span class="keyword">byte</span>[] dst = <span class="keyword">new</span> <span class="keyword">byte</span>[data.length];</div><div class="line">        Camera.Size previewSize = mCamera.getParameters().getPreviewSize();</div><div class="line">        <span class="keyword">if</span> (getDgree() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">//手机竖屏的时候要将获取的数据顺时针旋转90度，否则画面不是正着的，而是逆时针90度</span></div><div class="line">            dst = Util.rotateNV21Degree90(data, previewSize.width, previewSize.height);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            dst = data;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">int</span> bufferIndex = mMediaCodec.dequeueInputBuffer(<span class="number">5000000</span>);</div><div class="line">            <span class="keyword">if</span> (bufferIndex &gt;= <span class="number">0</span>) &#123;</div><div class="line">                inputBuffers[bufferIndex].clear();</div><div class="line">                <span class="comment">//将YUV420SP数据转换成YUV420P的格式，并将结果存入inputBuffers[bufferIndex]</span></div><div class="line">                mConvertor.convert(dst, inputBuffers[bufferIndex]);</div><div class="line">                mMediaCodec.queueInputBuffer(bufferIndex, <span class="number">0</span>,</div><div class="line">                        inputBuffers[bufferIndex].position(),</div><div class="line">                        System.nanoTime() / <span class="number">1000</span>, <span class="number">0</span>);</div><div class="line">                MediaCodec.BufferInfo bufferInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</div><div class="line">                <span class="keyword">int</span> outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</div><div class="line">                <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    ByteBuffer outputBuffer = outputBuffers[outputBufferIndex];</div><div class="line">                    <span class="keyword">byte</span>[] outData = <span class="keyword">new</span> <span class="keyword">byte</span>[bufferInfo.size];</div><div class="line">                    <span class="comment">//从buff中读取数据到outData中</span></div><div class="line">                    outputBuffer.get(outData);</div><div class="line">                    <span class="comment">//记录pps和sps，pps和sps数据开头是0x00 0x00 0x00 0x01 0x67，</span></div><div class="line">                    <span class="comment">// 0x67对应十进制103</span></div><div class="line">                    <span class="keyword">if</span> (outData[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; outData[<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; outData[<span class="number">2</span>] == <span class="number">0</span> </div><div class="line">                            &amp;&amp; outData[<span class="number">3</span>] == <span class="number">1</span> &amp;&amp; outData[<span class="number">4</span>] == <span class="number">103</span>) &#123;</div><div class="line">                        mSpsPps = outData;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (outData[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; outData[<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; outData[<span class="number">2</span>] == <span class="number">0</span> </div><div class="line">                            &amp;&amp; outData[<span class="number">3</span>] == <span class="number">1</span> &amp;&amp; outData[<span class="number">4</span>] == <span class="number">101</span>) &#123;</div><div class="line">                        <span class="comment">//关键帧开始规则是0x00 0x00 0x00 0x01 0x65，0x65对应十进制101</span></div><div class="line">                        <span class="comment">//在关键帧前面加上pps和sps数据</span></div><div class="line">                        <span class="keyword">byte</span>[] iframeData = <span class="keyword">new</span> <span class="keyword">byte</span>[mSpsPps.length + outData.length];</div><div class="line">                        System.arraycopy(mSpsPps, <span class="number">0</span>, iframeData, <span class="number">0</span>, mSpsPps.length);</div><div class="line">                        System.arraycopy(outData, <span class="number">0</span>, iframeData, mSpsPps.length, outData.length);</div><div class="line">                        outData = iframeData;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">//至此，这一帧的数据已经经过MediaCodec编码完毕，这个outData就是我们需要的数据了，</span></div><div class="line">                    <span class="comment">//因为EasyDarwin可以自动将H264打包为RTP，</span></div><div class="line">                    <span class="comment">//所以EasyPusher只需要负责将outData推给EasyDarwin就OK了</span></div><div class="line">                    <span class="comment">//保存H264数据到本地文件easy.h264</span></div><div class="line">                    Util.save(outData, <span class="number">0</span>, outData.length, path, <span class="keyword">true</span>);</div><div class="line">                    mMediaCodec.releaseOutputBuffer(outputBufferIndex, <span class="keyword">false</span>);</div><div class="line">                    outputBufferIndex = mMediaCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Log.e(<span class="string">"easypusher"</span>, <span class="string">"No buffer available !"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            StringWriter sw = <span class="keyword">new</span> StringWriter();</div><div class="line">            PrintWriter pw = <span class="keyword">new</span> PrintWriter(sw);</div><div class="line">            e.printStackTrace(pw);</div><div class="line">            String stack = sw.toString();</div><div class="line">            Log.e(<span class="string">"save_log"</span>, stack);</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            mCamera.addCallbackBuffer(dst);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>保存之后的文件easy.h264我用VLC播放器打开，截屏如下：<br></p>
<p><img src="http://img.blog.csdn.net/20160309132221153" alt="easy264截屏"></p>
<p><br>OK，基本上完毕了，该注意的地方都写在代码中了<br></p>
<p>需要Demo的请到这里<a href="https://github.com/kidloserme/MediaCodecDemo" target="_blank" rel="external">https://github.com/kidloserme/MediaCodecDemo</a></p>
</div></article><div class="tags"><a href="/tags/MediaCodec/">MediaCodec</a></div><div class="paginator"><a href="/2016/09/24/RxJava_Create_2016-09-24/" class="prev"><i class="iconfont icon-left"></i><span> 上一页</span></a><a href="/2016/09/24/2016-03-17-EventBus/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Holo Wang</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>